<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="/static/css/styles.css" type="text/css">

<head>

  <title>Aspect</title>
    <div class= header>
      <h1>Aspect</h1>
      <p>Using machine learning to detect Diabetic Retinopathy.</p>
    </div>
</head>

<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>
        function readURL(input) {
        document.getElementById("message").innerHTML= "Press upload to view prediction!";
          if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function(e) {
              $('#preview').attr('src', e.target.result);
            }

            reader.readAsDataURL(input.files[0]); // convert to base64 string
          }
        }

        $("#image").change(function() {
          readURL(this);
        });

        function process_image(form) {
        document.getElementById("message").innerHTML= "Loading prediction...";

          var file = document.getElementById('image').value;
          var formData = new FormData(document.querySelector('form'))
          var request = new XMLHttpRequest();
          request.open("POST", "/api/v1/predictor/diagnosis");
          request.send(formData);

          request.onload=function() {
                json=JSON.parse(request.responseText);
                if (json["success"]) {
                    var label = json["prediction"]["label"]
                    var distribution = json["prediction"]["probability_distribution"]
                    var topValue = distribution[label]

                    if(label == 0) {
                        document.getElementById("message").innerHTML= "Results are negative!\n Confidence: " + (topValue.toFixed(4) * 100).toString()+"%";
                    }
                    else if(label == 1) {
                        document.getElementById("message").innerHTML= "Mild Diabetic Retinopathy detected!\n Confidence: " + (topValue.toFixed(4) * 100).toString()+"%";
                    }
                    else if(label == 2) {
                        document.getElementById("message").innerHTML= "Moderate Diabetic Retinopathy detected!\n Confidence: " + (topValue.toFixed(4) * 100).toString()+"%";
                    }
                    else if(label == 3) {
                        document.getElementById("message").innerHTML= "Severe Diabetic Retinopathy detected!\n Confidence: " + (topValue.toFixed(4) * 100).toString()+"%";
                    }
                    else if(label == 4) {
                        document.getElementById("message").innerHTML= "Proliferate Diabetic Retinopathy detected!\n Confidence: " + (topValue.toFixed(4) * 100).toString()+"%";
                    }
                }
                else {
                    alert("There was an error processing the request!");
                    document.getElementById("message").innerHTML= "Could not make a prediction!";
                }
            };

        }
    </script>

        <form class=submit-form action="javascript:process_image(this)" id="form">
          Select image to upload:
          <input type="file" name="image" id="image" onchange="javascript:readURL(this)">
          <input type="submit" value="Upload Image" name="submit">
        </form>
    <img id="preview" src="#" alt="Image preview" class="image_preview"/>
    <div class=header>
        <h3 id="message">Your prediction will appear here!</h3>
    </div>
</body>
</html>